name: Daily Notebook Generation

on:
  schedule:
    - cron: '0 1 * * *'  # Run at 1am UTC
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to generate notebooks for (YYYY-MM-DD)'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "daily"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Initialize gh-pages branch if needed
        run: |
          if [ ! -d ".git" ]; then
            git clone --depth 1 https://github.com/${{ github.repository }}.git .
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

      - name: Checkout source notebooks
        uses: actions/checkout@v4
        with:
          ref: main
          path: source

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13
        working-directory: source

      - name: Install dependencies
        run: uv sync
        working-directory: source

      - name: Determine target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date }}"
          else
            TARGET_DATE=$(date -u -d "yesterday" +%Y-%m-%d)
          fi
          echo "target=$TARGET_DATE" >> $GITHUB_OUTPUT
          echo "Generating notebooks for: $TARGET_DATE"

      - name: Generate daily notebooks
        working-directory: source
        env:
          CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
          CLICKHOUSE_PORT: ${{ secrets.CLICKHOUSE_PORT }}
          CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_USER }}
          CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_PASSWORD }}
        run: |
          echo "CLICKHOUSE_HOST is set: $( [ -n \"$CLICKHOUSE_HOST\" ] && echo 'yes' || echo 'no' )"
          echo "CLICKHOUSE_USER is set: $( [ -n \"$CLICKHOUSE_USER\" ] && echo 'yes' || echo 'no' )"
          TARGET_DATE="${{ steps.date.outputs.target }}"
          OUTPUT_DIR="../daily/$TARGET_DATE"
          mkdir -p "$OUTPUT_DIR"

          for notebook in peerdas/*.ipynb; do
            echo "Processing $notebook for $TARGET_DATE..."
            uv run papermill "$notebook" "$OUTPUT_DIR/$(basename "$notebook")" \
              -p TARGET_DATE "$TARGET_DATE" \
              -p FORCE_QUERY true
          done

          # Convert to HTML
          for notebook in "$OUTPUT_DIR"/*.ipynb; do
            uv run jupyter nbconvert --to html --no-input "$notebook"
          done

          # Remove intermediate ipynb files
          rm "$OUTPUT_DIR"/*.ipynb

      - name: Generate latest notebooks
        working-directory: source
        env:
          CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
          CLICKHOUSE_PORT: ${{ secrets.CLICKHOUSE_PORT }}
          CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_USER }}
          CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_PASSWORD }}
        run: |
          # Use today's date for "latest" notebooks
          TODAY=$(date -u +%Y-%m-%d)
          mkdir -p ../latest
          for notebook in peerdas/*.ipynb; do
            BASENAME=$(basename "$notebook" .ipynb)
            uv run papermill "$notebook" "../latest/$BASENAME.ipynb" \
              -p TARGET_DATE "$TODAY" \
              -p FORCE_QUERY true
            uv run jupyter nbconvert --to html --no-input "../latest/$BASENAME.ipynb"
          done
          rm ../latest/*.ipynb

      - name: Prune old daily reports (keep 90 days)
        run: |
          if [ -d "daily" ]; then
            CUTOFF_DATE=$(date -u -d "90 days ago" +%Y-%m-%d)
            for date_dir in daily/*/; do
              dir_name=$(basename "$date_dir")
              if [[ "$dir_name" < "$CUTOFF_DATE" ]]; then
                echo "Removing old report: $dir_name"
                rm -rf "$date_dir"
              fi
            done
          fi

      - name: Generate index page
        run: |
          # Move latest notebooks to root
          mv latest/*.html . 2>/dev/null || true
          rmdir latest 2>/dev/null || true

          # Build date list for index
          DATE_LIST=""
          if [ -d "daily" ]; then
            for date_dir in $(ls -r daily/ 2>/dev/null); do
              if [ -d "daily/$date_dir" ]; then
                DATE_LIST="$DATE_LIST<li><a href=\"daily/$date_dir/\">$date_dir</a></li>"

                # Create index for each date
                cat > "daily/$date_dir/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>PeerDAS Analysis - $date_dir</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
              .back { margin-bottom: 20px; }
            </style>
          </head>
          <body>
            <p class="back"><a href="../../">&larr; Back to index</a></p>
            <h1>PeerDAS Analysis - $date_dir</h1>
            <ul>
              <li><a href="01-blob-inclusion.html">Blob Inclusion</a></li>
              <li><a href="02-blob-flow.html">Blob Flow</a></li>
              <li><a href="03-column-propagation.html">Column Propagation</a></li>
            </ul>
          </body>
          </html>
          EOF
              fi
            done
          fi

          if [ -z "$DATE_LIST" ]; then
            DATE_LIST="<li>No historical reports available yet.</li>"
          fi

          cat > index.html << HEREDOC
          <!DOCTYPE html>
          <html>
          <head>
            <title>Ethereum PeerDAS Analysis</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              h2 { color: #555; margin-top: 40px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
              .description { color: #666; font-size: 14px; margin-left: 10px; }
              .date-list { columns: 3; column-gap: 40px; }
              .date-list li { font-size: 16px; break-inside: avoid; }
            </style>
          </head>
          <body>
            <h1>Ethereum PeerDAS Analysis Notebooks</h1>

            <h2>Latest (Last 24 Hours)</h2>
            <ul>
              <li><a href="01-blob-inclusion.html">Blob Inclusion</a><span class="description">Analysis of blob inclusion patterns</span></li>
              <li><a href="02-blob-flow.html">Blob Flow</a><span class="description">Blob flow through validators, builders, and relays</span></li>
              <li><a href="03-column-propagation.html">Column Propagation</a><span class="description">Data column propagation timing</span></li>
            </ul>

            <h2>Historical Daily Reports (Last 90 Days)</h2>
            <ul class="date-list">
              $DATE_LIST
            </ul>
          </body>
          </html>
          HEREDOC

      - name: Commit to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          rm -rf source
          git add -A
          git commit -m "Update notebooks for ${{ steps.date.outputs.target }}" || echo "No changes"
          git push --force origin HEAD:gh-pages

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
