name: Build and Deploy Quarto Site

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["Fetch Daily Data"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout data branch
        uses: actions/checkout@v4
        with:
          ref: data
          path: data-checkout
        continue-on-error: true

      - name: Initialize data directory if needed
        run: |
          if [ ! -d "data-checkout" ]; then
            mkdir -p data-checkout
            echo '{"dates": [], "latest": null}' > data-checkout/manifest.json
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Get dates from manifest
        id: manifest
        run: |
          if [ -f "data-checkout/manifest.json" ]; then
            LATEST=$(jq -r '.latest // empty' data-checkout/manifest.json)
            DATES=$(jq -r '.dates | join(",")' data-checkout/manifest.json)
          fi
          LATEST=${LATEST:-$(date -u +%Y-%m-%d)}
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "dates=$DATES" >> $GITHUB_OUTPUT
          echo "Building for latest date: $LATEST"

      - name: Generate archive page
        run: |
          python3 scripts/generate_archive.py

      - name: Build Quarto site
        env:
          DATA_ROOT: ${{ github.workspace }}/data-checkout
          TARGET_DATE: ${{ steps.manifest.outputs.latest }}
        run: |
          quarto render

      - name: Generate historical HTML pages
        env:
          DATA_ROOT: ${{ github.workspace }}/data-checkout
        run: |
          # Read dates from manifest
          if [ ! -f "data-checkout/manifest.json" ]; then
            echo "No manifest found, skipping historical pages"
            exit 0
          fi

          DATES=$(jq -r '.dates[]' data-checkout/manifest.json 2>/dev/null || echo "")
          LATEST="${{ steps.manifest.outputs.latest }}"

          for DATE in $DATES; do
            if [ "$DATE" = "$LATEST" ]; then
              echo "Skipping latest date $DATE (already in main build)"
              continue
            fi

            echo "Processing historical date: $DATE"
            mkdir -p "_site/archive/$DATE"

            for qmd in notebooks/*.qmd; do
              BASENAME=$(basename "$qmd" .qmd)

              # Render individual notebook with specific date
              TARGET_DATE="$DATE" quarto render "$qmd" \
                --output-dir "../_site/archive/$DATE" \
                --output "$BASENAME.html" 2>/dev/null || continue
            done

            # Create index for this date
            python3 scripts/generate_historical_index.py "$DATE" "_site/archive/$DATE"
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
