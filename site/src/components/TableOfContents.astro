---
// Static Table of Contents component
// Receives headings extracted at build time
import Icon from './Icon.astro';

import type { MarkdownHeading } from 'astro';

interface Props {
  headings?: MarkdownHeading[];
}

const { headings = [] } = Astro.props;
---

{
  headings.length > 0 && (
    <nav class="group/nav relative flex flex-col items-end" id="toc-nav">
      {/* Header - instantly visible on hover */}
      <div class="border-border text-muted-foreground mb-3 flex w-full items-center justify-end gap-1.5 pb-1 opacity-0 group-hover/toc:opacity-100">
        <span class="text-[0.625rem] font-semibold tracking-wide uppercase">On this page</span>
      </div>

      <ul class="relative m-0 flex list-none flex-col items-end p-0" id="toc-list">
        {headings.map((heading) => (
          <li class="group/item relative m-0 w-full">
            <a href={`#${heading.slug}`} class="toc-link flex h-6 w-full flex-row items-center justify-end gap-2 no-underline">
              {/* The Label */}
              <span class="toc-label text-muted-foreground group-hover/item:text-foreground pointer-events-none inline-flex items-center text-[0.8125rem] leading-tight whitespace-nowrap opacity-0 group-hover/toc:opacity-100">
                {heading.text}
              </span>

              {/* The Dot (circle) */}
              <div class="toc-dot border-muted-foreground/30 group-hover/item:border-primary pointer-events-none h-1.5 w-1.5 shrink-0 translate-y-px rounded-full border bg-transparent group-hover/item:scale-150" />
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<style>
  /* Active states */
  .toc-link.active .toc-dot {
    background-color: var(--primary);
    border-color: var(--primary);
    transform: scale(1.1);
  }

  .toc-link.active .toc-label {
    color: var(--foreground);
    font-weight: 500;
  }
</style>

<script>
  function initTOC() {
    const tocList = document.getElementById('toc-list');
    if (!tocList) return;

    const tocLinks = tocList.querySelectorAll('.toc-link');
    const headingIds = Array.from(tocLinks)
      .map((link) => link.getAttribute('href')?.slice(1))
      .filter(Boolean);

    if (headingIds.length === 0) return;

    const setActive = (link: HTMLElement) => {
      tocLinks.forEach((l) => l.classList.remove('active'));
      link.classList.add('active');
    };

    // Highlight active section on scroll
    const observer = new IntersectionObserver(
      (entries) => {
        const visibleEntry = entries.find((e) => e.isIntersecting);
        if (visibleEntry) {
          const tocLink = tocList.querySelector(`a[href="#${visibleEntry.target.id}"]`) as HTMLElement;
          if (tocLink) {
            setActive(tocLink);
          }
        }
      },
      {
        // Tune margins to select the item correctly at the top of viewport
        rootMargin: '-48px 0px -85% 0px',
        threshold: 0,
      },
    );

    headingIds.forEach((id) => {
      const heading = document.getElementById(id!);
      if (heading) {
        observer.observe(heading);
      }
    });

    // Smooth scroll on click
    tocList.addEventListener('click', (e: MouseEvent) => {
      const target = e.target as HTMLElement;
      const link = target.closest('.toc-link') as HTMLAnchorElement;

      if (link) {
        e.preventDefault();
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
          const id = href.slice(1);
          const heading = document.getElementById(id);
          if (heading) {
            heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
            history.pushState(null, '', href);
          }
        }
      }
    });
  }

  // Run on load and on Astro page transitions
  initTOC();
  document.addEventListener('astro:page-load', initTOC);
</script>
