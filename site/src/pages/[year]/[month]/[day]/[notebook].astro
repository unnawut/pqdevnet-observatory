---
import NotebookLayout from '@/layouts/NotebookLayout.astro';
import { extractHeadings } from '@/lib/extract-headings';
import { getNotebooks, getManifest } from '@/lib/data';

// Load manifest
const manifest = getManifest();

export function getStaticPaths() {
  const notebooks = getNotebooks();
  const manifest = getManifest();
  const paths: Array<{ params: { year: string; month: string; day: string; notebook: string }; props: { isoDate: string } }> = [];

  for (const isoDate of Object.keys(manifest.dates || {})) {
    const dateData = manifest.dates![isoDate];
    const [year, month, day] = isoDate.split('-');
    for (const nb of notebooks) {
      if (dateData[nb.id]) {
        paths.push({
          params: { year, month, day, notebook: nb.id },
          props: { isoDate },
        });
      }
    }
  }

  return paths;
}

const { year, month, day, notebook: notebookId } = Astro.params;
const { isoDate } = Astro.props;

// Use provided isoDate or construct from params
const dateIso = isoDate || `${year}-${month}-${day}`;
const notebooks = getNotebooks();
const notebook = notebooks.find((nb) => nb.id === notebookId);

if (!notebook) {
  return Astro.redirect('/404');
}

const dateData = manifest.dates?.[dateIso] || {};
const notebookData = dateData[notebook.id];

if (!notebookData) {
  return Astro.redirect(`/${year}/${month}/${day}`);
}

const htmlPath = notebookData.html_path || `${year}/${month}/${day}/${notebook.id}.html`;
const headings = extractHeadings(htmlPath);
---

<NotebookLayout
  title={`${notebook.title} - ${dateIso}`}
  description={notebook.description}
  headings={headings}
  currentDate={dateIso}
  notebookId={notebook.id}
  htmlPath={htmlPath}
/>
