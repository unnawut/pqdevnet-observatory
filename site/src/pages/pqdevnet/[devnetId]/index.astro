---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Icon from '@/components/Icon.astro';
import { PQDevnetSiteData, getPQDevnetNotebooks, getAvailableDevnets } from '@/lib/PQDevnetSiteData';

export function getStaticPaths() {
  const devnets = getAvailableDevnets();
  return devnets.map((devnet) => ({
    params: { devnetId: devnet },
  }));
}

const { devnetId } = Astro.params;
const pqDevnetData = PQDevnetSiteData.load();
const notebooks = pqDevnetData.notebooks;

if (!pqDevnetData.hasDevnet(devnetId!)) {
  return Astro.redirect('/404');
}

const base = import.meta.env.BASE_URL;
const isLatest = devnetId === pqDevnetData.latestDevnet;

// Format devnet ID for display (e.g., "pqdevnet-20260203T0100Z" -> "PQ Devnet 2026-02-03")
const formatDevnetDisplay = (id: string) => {
  const match = id.match(/pqdevnet-(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})Z/);
  if (match) {
    return `PQ Devnet ${match[1]}-${match[2]}-${match[3]}`;
  }
  return id;
};
---

<BaseLayout title={`PQ Devnet - ${formatDevnetDisplay(devnetId!)}`} description="PQ Devnet metrics analysis">
  <div class="mx-auto max-w-4xl">
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <span class="bg-primary text-primary-foreground px-2 py-1 text-xs font-mono uppercase tracking-wider">
          PQ Devnet
        </span>
        {isLatest && (
          <span class="border border-primary/30 text-primary px-2 py-1 text-xs font-mono uppercase tracking-wider">
            Latest
          </span>
        )}
      </div>
      <h1 class="font-serif text-4xl font-normal -tracking-tight mb-2">
        {formatDevnetDisplay(devnetId!)}
      </h1>
      <p class="text-muted-foreground">
        Post-quantum cryptography performance analysis for Ethereum consensus layer.
      </p>
    </header>

    <section>
      <h2 class="text-sm font-mono uppercase tracking-wider text-muted-foreground mb-4">
        Available Notebooks
      </h2>
      <ul class="space-y-2">
        {notebooks.map((nb) => {
          const notebookData = pqDevnetData.getNotebookData(devnetId!, nb.id);
          const hasRendered = !!notebookData;
          const href = hasRendered ? `${base}pqdevnet/${devnetId}/${nb.id}` : null;

          return (
            <li>
              <a
                href={href || '#'}
                class:list={[
                  'group flex items-center gap-4 p-4 border transition-all',
                  hasRendered
                    ? 'hover:border-primary hover:bg-muted cursor-pointer'
                    : 'opacity-50 cursor-not-allowed',
                ]}
              >
                <span class="flex h-10 w-10 shrink-0 items-center justify-center bg-muted text-muted-foreground group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
                  <Icon name={nb.icon || 'FileText'} size={20} />
                </span>
                <div class="flex-1 min-w-0">
                  <h3 class="font-medium text-foreground group-hover:text-primary transition-colors">
                    {nb.title}
                  </h3>
                  {nb.description && (
                    <p class="text-sm text-muted-foreground truncate">
                      {nb.description}
                    </p>
                  )}
                </div>
                {hasRendered ? (
                  <Icon name="ChevronRight" size={16} class="text-muted-foreground group-hover:text-primary transition-colors" />
                ) : (
                  <span class="text-xs text-muted-foreground">Not rendered</span>
                )}
              </a>
            </li>
          );
        })}
      </ul>
    </section>
  </div>
</BaseLayout>
