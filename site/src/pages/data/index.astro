---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Icon from '@/components/Icon.astro';
import fs from 'node:fs';
import path from 'node:path';

// Data manifest structure for PQ Devnet
interface QueryData {
  fetched_at: string;
  row_count: number;
  file_size_bytes: number;
}

interface DataManifest {
  devnets: string[];
  devnet_queries: Record<string, Record<string, QueryData>>;
}

// Load data manifest from notebooks/data/manifest.json
function loadDataManifest(): DataManifest {
  const manifestPath = path.join(process.cwd(), '..', 'notebooks', 'data', 'manifest.json');
  try {
    if (fs.existsSync(manifestPath)) {
      const content = fs.readFileSync(manifestPath, 'utf-8');
      return JSON.parse(content);
    }
  } catch (e) {
    console.error('Failed to load data manifest', e);
  }
  return { devnets: [], devnet_queries: {} };
}

// Format bytes to human-readable size
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

// Format devnet ID for display (e.g., "pqdevnet-20260203T0100Z" -> "PQ Devnet 2026-02-03")
function formatDevnetDisplay(id: string): string {
  const match = id.match(/pqdevnet-(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})Z/);
  return match ? `PQ Devnet ${match[1]}-${match[2]}-${match[3]}` : id;
}

const manifest = loadDataManifest();
const base = import.meta.env.BASE_URL;

// Sort devnets newest first (higher number = newer)
const sortedDevnets = [...(manifest.devnets || [])].sort().reverse();
const latestDevnet = sortedDevnets[0] || '';

// Get total file count and size
let totalFiles = 0;
let totalSize = 0;
for (const devnet of sortedDevnets) {
  const queries = manifest.devnet_queries?.[devnet] || {};
  for (const query of Object.values(queries)) {
    totalFiles++;
    totalSize += query.file_size_bytes || 0;
  }
}
---

<BaseLayout title="Data downloads">
  <div class="max-w-4xl">
    <!-- Header -->
    <header class="mb-12">
      <div class="text-muted-foreground bg-muted mb-6 inline-flex items-center gap-2 px-3 py-1.5 font-mono text-[0.6875rem] tracking-widest uppercase">
        <Icon name="Download" size={12} />
        <span>Parquet Files</span>
      </div>
      <h1 class="m-0 mb-6 font-serif text-4xl leading-tight font-normal -tracking-wide max-md:text-3xl">
        <span class="text-foreground">Data downloads</span>
      </h1>
      <p class="text-muted-foreground max-w-xl text-base leading-relaxed">
        Parquet files generated by our data pipelines, from which the notebook visualizations are rendered.
        Download them for your own analysis.
      </p>
      <div class="text-muted-foreground mt-4 flex items-center gap-4 text-sm">
        <span>{totalFiles} files</span>
        <span class="text-border">|</span>
        <span>{formatFileSize(totalSize)} total</span>
        <span class="text-border">|</span>
        <span>{sortedDevnets.length} devnets</span>
      </div>
    </header>

    <!-- Data by Devnet -->
    {sortedDevnets.map((devnet) => {
      const queries = manifest.devnet_queries?.[devnet] || {};
      const queryNames = Object.keys(queries).sort();
      const isLatest = devnet === latestDevnet;

      return (
        <section class="mb-10">
          <div class="mb-4 flex items-center gap-3">
            <h2 class="m-0 font-serif text-xl font-normal -tracking-tight">
              {formatDevnetDisplay(devnet)}
            </h2>
            {isLatest && (
              <span class="bg-primary text-primary-foreground px-2 py-0.5 text-[0.625rem] font-mono tracking-wide uppercase">
                Latest
              </span>
            )}
          </div>

          <div class="border-border bg-card overflow-hidden border">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-border bg-muted border-b">
                  <th class="text-muted-foreground px-4 py-2.5 text-left font-mono text-[0.6875rem] tracking-wide uppercase font-medium">File</th>
                  <th class="text-muted-foreground px-4 py-2.5 text-right font-mono text-[0.6875rem] tracking-wide uppercase font-medium">Rows</th>
                  <th class="text-muted-foreground px-4 py-2.5 text-right font-mono text-[0.6875rem] tracking-wide uppercase font-medium">Size</th>
                </tr>
              </thead>
              <tbody>
                {queryNames.map((queryName, idx) => {
                  const query = queries[queryName];
                  const filename = `${queryName}.parquet`;
                  const downloadUrl = `${base}data/${devnet}/${filename}`;

                  return (
                    <tr class={`group border-border ${idx < queryNames.length - 1 ? 'border-b' : ''} hover:bg-muted/50 transition-colors`}>
                      <td class="px-4 py-3">
                        <a
                          href={downloadUrl}
                          download
                          class="text-foreground hover:text-primary inline-flex items-center gap-2 no-underline transition-colors"
                        >
                          <code class="font-mono text-[0.8125rem]">{filename}</code>
                          <span class="text-muted-foreground group-hover:text-primary opacity-0 group-hover:opacity-100 transition-opacity">
                            <Icon name="Download" size={14} />
                          </span>
                        </a>
                      </td>
                      <td class="text-muted-foreground px-4 py-3 text-right font-mono text-[0.8125rem]">
                        {query.row_count.toLocaleString()}
                      </td>
                      <td class="text-muted-foreground px-4 py-3 text-right font-mono text-[0.8125rem]">
                        {formatFileSize(query.file_size_bytes)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </section>
      );
    })}

    {sortedDevnets.length === 0 && (
      <div class="border-border bg-muted text-muted-foreground border p-8 text-center">
        No data files available yet.
      </div>
    )}
  </div>
</BaseLayout>
